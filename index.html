<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MathSkillz - Henry's Math Adventure</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap');

* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --mc-green: #5D8C3E; --mc-brown: #8B6914; --mc-stone: #7F7F7F;
  --mc-dirt: #6B4226; --mc-sky: #87CEEB; --mc-gold: #FFD700;
  --ninja-red: #E63946; --ninja-blue: #457B9D; --ninja-green: #2A9D8F;
  --ninja-black: #1D1D2C; --ninja-white: #F1FAEE;
  --poke-red: #FF4444; --poke-blue: #3B4CCA; --poke-yellow: #FFDE00;
  --xp-bar: #44DD44; --hp-bar: #FF4444; --mp-bar: #4488FF;
}
html, body { width:100%; height:100%; overflow:hidden; font-family:'Nunito',sans-serif; background:#1a1a2e; }

#game-container {
  width:100%; height:100%; position:relative; overflow:hidden;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
}

/* ===== SCREENS ===== */
.screen { display:none; position:absolute; inset:0; flex-direction:column; align-items:center; justify-content:center; z-index:10; }
.screen.active { display:flex; }

/* Title Screen */
#title-screen {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  text-align:center; gap:20px;
}
#title-screen h1 {
  font-family:'Press Start 2P',monospace; font-size:clamp(18px,4vw,36px);
  color:var(--poke-yellow); text-shadow: 3px 3px 0 #333, 0 0 20px rgba(255,222,0,0.5);
  line-height:1.4;
}
#title-screen .subtitle {
  font-family:'Fredoka One',sans-serif; font-size:clamp(14px,3vw,24px);
  color:var(--ninja-white); opacity:0.9;
}
.pixel-border {
  border: 4px solid var(--mc-brown);
  box-shadow: inset 0 0 0 2px var(--mc-gold), 0 0 0 2px #000;
  image-rendering: pixelated;
}
.btn {
  font-family:'Fredoka One',sans-serif; font-size:clamp(14px,2.5vw,22px);
  padding:12px 32px; border:none; border-radius:8px; cursor:pointer;
  transition: transform 0.15s, box-shadow 0.15s; color:#fff;
  text-shadow:1px 1px 2px rgba(0,0,0,0.5);
}
.btn:hover { transform:scale(1.05); }
.btn:active { transform:scale(0.95); }
.btn-primary { background:linear-gradient(180deg,var(--poke-red),#cc2222); box-shadow:0 4px 0 #991111; }
.btn-green { background:linear-gradient(180deg,var(--mc-green),#3d6c1e); box-shadow:0 4px 0 #2d5c0e; }
.btn-blue { background:linear-gradient(180deg,var(--ninja-blue),#2a5a7d); box-shadow:0 4px 0 #1a4a6d; }
.btn-gold { background:linear-gradient(180deg,var(--mc-gold),#ccaa00); box-shadow:0 4px 0 #aa8800; color:#333; }

/* World Map */
#map-screen { background:linear-gradient(180deg,#87CEEB 0%,#98D8C8 60%,#5D8C3E 100%); }
.map-header {
  width:100%; padding:8px 16px; display:flex; justify-content:space-between; align-items:center;
  background:rgba(0,0,0,0.7); color:#fff; position:absolute; top:0; z-index:5;
}
.player-stats { display:flex; gap:12px; align-items:center; font-size:clamp(10px,1.8vw,14px); }
.stat-bar { width:80px; height:12px; background:#333; border-radius:6px; overflow:hidden; }
.stat-bar-fill { height:100%; border-radius:6px; transition:width 0.5s; }
.xp-fill { background:var(--xp-bar); }
.worlds-container {
  display:flex; flex-wrap:wrap; gap:16px; justify-content:center; align-items:center;
  padding:60px 20px 20px; max-width:800px; width:100%;
}
.world-card {
  width:clamp(120px,25vw,160px); height:clamp(140px,28vw,180px);
  border-radius:12px; cursor:pointer; position:relative; overflow:hidden;
  transition: transform 0.2s; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:8px;
}
.world-card:hover { transform:scale(1.08); }
.world-card.locked { filter:grayscale(0.7) brightness(0.6); cursor:not-allowed; }
.world-card .world-icon { font-size:clamp(36px,7vw,56px); }
.world-card .world-name {
  font-family:'Fredoka One',sans-serif; font-size:clamp(10px,2vw,14px);
  color:#fff; text-shadow:1px 1px 2px rgba(0,0,0,0.8); text-align:center;
}
.world-card .world-progress { font-size:clamp(8px,1.5vw,11px); color:rgba(255,255,255,0.8); }
.lock-icon { position:absolute; top:8px; right:8px; font-size:20px; }

/* Topic Select */
#topic-screen { background:linear-gradient(135deg,#16213e,#1a1a2e); overflow-y:auto; }
.topics-grid {
  display:flex; flex-direction:column; gap:10px; padding:60px 20px 20px;
  max-width:600px; width:100%; overflow-y:auto; max-height:100%;
}
.topic-row {
  display:flex; align-items:center; gap:12px; padding:12px 16px;
  background:rgba(255,255,255,0.08); border-radius:10px; cursor:pointer;
  transition: background 0.2s, transform 0.15s;
}
.topic-row:hover { background:rgba(255,255,255,0.15); transform:translateX(4px); }
.topic-row.locked { opacity:0.4; cursor:not-allowed; }
.topic-row.locked:hover { transform:none; }
.topic-row.completed { border-left:4px solid var(--mc-green); }
.topic-row .topic-icon { font-size:28px; }
.topic-row .topic-info { flex:1; color:#fff; }
.topic-row .topic-name { font-family:'Fredoka One',sans-serif; font-size:clamp(12px,2vw,16px); }
.topic-row .topic-desc { font-size:clamp(9px,1.5vw,12px); opacity:0.7; }
.topic-stars { display:flex; gap:2px; font-size:16px; }

/* Battle Screen */
#battle-screen {
  background:linear-gradient(180deg,#1a1a2e 0%,#16213e 100%);
  padding:10px; gap:8px;
}
.battle-header {
  width:100%; display:flex; justify-content:space-between; align-items:center;
  padding:4px 8px;
}
.battle-info { color:#fff; font-size:clamp(10px,1.8vw,14px); }
.enemy-area {
  width:100%; max-width:500px; display:flex; flex-direction:column;
  align-items:center; gap:8px; padding:8px;
}
.enemy-sprite {
  width:clamp(80px,20vw,140px); height:clamp(80px,20vw,140px);
  display:flex; align-items:center; justify-content:center;
  font-size:clamp(48px,12vw,96px); position:relative;
  animation: enemyBob 2s ease-in-out infinite;
}
@keyframes enemyBob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
.enemy-hp-bar { width:80%; max-width:300px; height:16px; background:#333; border-radius:8px; overflow:hidden; }
.enemy-hp-fill { height:100%; background:var(--hp-bar); border-radius:8px; transition:width 0.5s; }
.enemy-name { color:#fff; font-family:'Fredoka One',sans-serif; font-size:clamp(12px,2.5vw,18px); }

.question-area {
  width:100%; max-width:550px; background:rgba(255,255,255,0.05);
  border-radius:16px; padding:16px; text-align:center;
  border:2px solid rgba(255,255,255,0.1);
}
.question-text {
  color:#fff; font-size:clamp(16px,3.5vw,28px); font-weight:900;
  margin-bottom:12px; min-height:40px; line-height:1.3;
}
.answers-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:8px;
}
.answer-btn {
  padding:clamp(10px,2vw,16px); border:2px solid rgba(255,255,255,0.2);
  border-radius:10px; background:rgba(255,255,255,0.08); color:#fff;
  font-size:clamp(14px,3vw,22px); font-weight:700; cursor:pointer;
  transition: all 0.15s; font-family:'Nunito',sans-serif;
}
.answer-btn:hover { background:rgba(255,255,255,0.18); transform:scale(1.03); }
.answer-btn.correct { background:var(--mc-green)!important; border-color:var(--mc-green)!important; animation:correctPulse 0.5s; }
.answer-btn.wrong { background:var(--poke-red)!important; border-color:var(--poke-red)!important; animation:shake 0.4s; }
@keyframes correctPulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }

.player-battle-area {
  width:100%; max-width:500px; display:flex; align-items:center;
  justify-content:space-between; padding:0 16px;
}
.player-sprite { font-size:clamp(40px,10vw,72px); }
.combo-display {
  color:var(--mc-gold); font-family:'Press Start 2P',monospace;
  font-size:clamp(10px,2vw,16px); text-align:right;
}

/* Results Screen */
#results-screen {
  background:linear-gradient(135deg,#1a1a2e,#16213e);
  text-align:center; gap:16px;
}
.results-title {
  font-family:'Press Start 2P',monospace; font-size:clamp(16px,4vw,32px);
  color:var(--mc-gold);
}
.results-stats { color:#fff; font-size:clamp(12px,2.5vw,18px); line-height:2; }
.rewards-area { display:flex; gap:16px; flex-wrap:wrap; justify-content:center; }
.reward-item {
  background:rgba(255,255,255,0.1); border-radius:12px; padding:12px;
  text-align:center; color:#fff; min-width:80px;
}
.reward-item .reward-icon { font-size:32px; }
.reward-item .reward-text { font-size:11px; margin-top:4px; }

/* Stats/Profile */
#stats-screen {
  background:linear-gradient(135deg,#1a1a2e,#16213e);
  overflow-y:auto; padding:20px;
}
.stats-content { max-width:600px; width:100%; color:#fff; }
.stats-section { margin-bottom:20px; }
.stats-section h3 { font-family:'Fredoka One',sans-serif; color:var(--mc-gold); margin-bottom:8px; }
.collection-grid { display:flex; flex-wrap:wrap; gap:8px; }
.collection-item {
  width:60px; height:60px; background:rgba(255,255,255,0.08);
  border-radius:8px; display:flex; align-items:center; justify-content:center;
  font-size:28px; position:relative;
}
.collection-item.locked { filter:grayscale(1) brightness(0.3); }
.achievement-row {
  display:flex; align-items:center; gap:8px; padding:6px;
  background:rgba(255,255,255,0.05); border-radius:6px; margin-bottom:4px;
}
.achievement-row.earned { border-left:3px solid var(--mc-gold); }

/* Back button */
.back-btn {
  position:absolute; top:8px; left:8px; z-index:20;
  background:rgba(0,0,0,0.5); color:#fff; border:none;
  border-radius:50%; width:36px; height:36px; font-size:18px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
}
.back-btn:hover { background:rgba(0,0,0,0.8); }

/* Streak Banner */
.streak-banner {
  position:absolute; top:50px; left:50%; transform:translateX(-50%);
  background:linear-gradient(90deg,var(--poke-red),var(--mc-gold));
  color:#fff; padding:8px 24px; border-radius:20px; font-family:'Fredoka One',sans-serif;
  font-size:clamp(12px,2vw,16px); z-index:30; animation:slideDown 0.5s;
  display:none;
}
@keyframes slideDown { from{transform:translateX(-50%) translateY(-60px)} to{transform:translateX(-50%) translateY(0)} }

/* Toast notifications */
.toast {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.85); color:#fff; padding:10px 24px;
  border-radius:20px; font-size:14px; z-index:100; animation:toastIn 0.3s;
  pointer-events:none;
}
@keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(20px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }

/* Damage number float */
.damage-float {
  position:absolute; color:var(--mc-gold); font-family:'Press Start 2P',monospace;
  font-size:20px; animation:floatUp 1s forwards; pointer-events:none; z-index:50;
}
@keyframes floatUp { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-60px)} }

/* Level up overlay */
.level-up-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:none; align-items:center; justify-content:center; z-index:200;
}
.level-up-overlay.active { display:flex; }
.level-up-box {
  background:linear-gradient(135deg,#2a1a4e,#1a1a3e); border:3px solid var(--mc-gold);
  border-radius:16px; padding:32px; text-align:center; color:#fff;
  animation:popIn 0.4s;
}
@keyframes popIn { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }
.level-up-box h2 { font-family:'Press Start 2P',monospace; color:var(--mc-gold); font-size:clamp(14px,3vw,24px); margin-bottom:12px; }

/* Number input for typed answers */
.number-input-area { display:flex; gap:8px; justify-content:center; align-items:center; margin-top:8px; }
.number-input {
  width:clamp(100px,30vw,200px); padding:12px; font-size:clamp(18px,4vw,28px);
  text-align:center; border:2px solid rgba(255,255,255,0.3); border-radius:10px;
  background:rgba(255,255,255,0.1); color:#fff; font-family:'Nunito',sans-serif;
  font-weight:700; outline:none;
}
.number-input:focus { border-color:var(--mc-gold); }
.submit-answer-btn {
  padding:12px 20px; background:var(--mc-green); border:none; border-radius:10px;
  color:#fff; font-size:clamp(14px,3vw,20px); cursor:pointer; font-weight:700;
}

/* Timer bar */
.timer-bar { width:100%; max-width:500px; height:6px; background:#333; border-radius:3px; overflow:hidden; }
.timer-fill { height:100%; background:var(--mc-gold); transition:width 0.1s linear; }
.timer-fill.urgent { background:var(--poke-red); }

/* Particle canvas background */
#particle-canvas {
  position:fixed; inset:0; z-index:0; pointer-events:none;
}

/* Screen shake */
.screen-shake { animation: screenShake 0.3s; }
@keyframes screenShake { 0%,100%{transform:translate(0)} 25%{transform:translate(-4px,2px)} 50%{transform:translate(4px,-2px)} 75%{transform:translate(-2px,4px)} }

/* XP popup */
.xp-popup {
  position:absolute; color:var(--mc-gold); font-family:'Press Start 2P',monospace;
  font-size:14px; animation:xpFloat 1.5s forwards; pointer-events:none; z-index:60;
  text-shadow:0 0 8px rgba(255,215,0,0.8);
}
@keyframes xpFloat { 0%{opacity:1;transform:translateY(0) scale(1)} 50%{transform:translateY(-30px) scale(1.3)} 100%{opacity:0;transform:translateY(-60px) scale(0.8)} }

/* Correct answer glow */
.answer-btn.correct {
  background:var(--mc-green)!important; border-color:var(--mc-green)!important;
  animation:correctPulse 0.5s;
  box-shadow: 0 0 20px rgba(93,140,62,0.6);
}
.answer-btn.wrong {
  background:var(--poke-red)!important; border-color:var(--poke-red)!important;
  animation:shake 0.4s;
  box-shadow: 0 0 20px rgba(255,68,68,0.4);
}

/* Enhanced enemy hit animation */
.enemy-hit { animation: enemyHit 0.4s; }
@keyframes enemyHit { 0%{filter:brightness(1)} 25%{filter:brightness(3) hue-rotate(30deg)} 50%{filter:brightness(0.5)} 100%{filter:brightness(1)} }

/* Title screen animated bg */
#title-screen::before {
  content:''; position:absolute; inset:0; z-index:-1;
  background:
    radial-gradient(circle at 20% 80%, rgba(255,68,68,0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(59,76,202,0.1) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(255,222,0,0.05) 0%, transparent 60%);
  animation: bgPulse 4s ease-in-out infinite;
}
@keyframes bgPulse { 0%,100%{opacity:0.8} 50%{opacity:1.2} }

/* World card hover glow */
.world-card:not(.locked):hover {
  box-shadow: 0 0 25px rgba(255,215,0,0.3), inset 0 0 0 2px var(--mc-gold);
}

/* Topic row animated indicator */
.topic-row:not(.locked)::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
  background:linear-gradient(180deg,var(--mc-gold),var(--poke-yellow));
  opacity:0; transition:opacity 0.2s;
}
.topic-row:not(.locked):hover::before { opacity:1; }
.topic-row { position:relative; }

/* Star rating animation */
.stars-earned .star { display:inline-block; animation:starPop 0.3s backwards; }
.stars-earned .star:nth-child(1) { animation-delay:0.1s; }
.stars-earned .star:nth-child(2) { animation-delay:0.3s; }
.stars-earned .star:nth-child(3) { animation-delay:0.5s; }
@keyframes starPop { 0%{transform:scale(0) rotate(-180deg);opacity:0} 100%{transform:scale(1) rotate(0);opacity:1} }

/* Battle entry animation */
#battle-screen.active .enemy-sprite { animation: enemyEnter 0.6s ease-out, enemyBob 2s ease-in-out 0.6s infinite; }
@keyframes enemyEnter { 0%{transform:translateY(-100px) scale(0);opacity:0} 100%{transform:translateY(0) scale(1);opacity:1} }

/* Responsive */
@media (max-width:500px) {
  .answers-grid { grid-template-columns:1fr 1fr; gap:6px; }
  .world-card { width:100px; height:120px; }
}
</style>
</head>
<body>
<canvas id="particle-canvas"></canvas>
<div id="game-container">
  <!-- TITLE SCREEN -->
  <div id="title-screen" class="screen active">
    <div style="font-size:64px;margin-bottom:8px">&#9876;&#65039;</div>
    <h1>MATH SKILLZ</h1>
    <div class="subtitle">Henry's Epic Math Adventure</div>
    <div style="display:flex;gap:16px;font-size:40px;margin:8px 0">
      <span title="Pokemon">&#128050;</span>
      <span title="Ninja">&#129399;</span>
      <span title="Blocks">&#129513;</span>
    </div>
    <button class="btn btn-primary" onclick="G.startGame()" id="start-btn">START ADVENTURE</button>
    <button class="btn btn-blue" onclick="G.showScreen('stats-screen')" style="font-size:14px">Collection & Stats</button>
    <div style="color:rgba(255,255,255,0.4);font-size:11px;margin-top:12px">Press F for fullscreen</div>
  </div>

  <!-- WORLD MAP -->
  <div id="map-screen" class="screen">
    <button class="back-btn" onclick="G.showScreen('title-screen')">&#8592;</button>
    <div class="map-header">
      <div class="player-stats">
        <span id="player-name-display">Henry</span>
        <span id="level-display">Lv.1</span>
        <span id="belt-display">&#129399; White Belt</span>
      </div>
      <div class="player-stats">
        <span>XP</span>
        <div class="stat-bar"><div class="stat-bar-fill xp-fill" id="xp-bar-fill" style="width:0%"></div></div>
        <span id="xp-text">0/100</span>
        <span id="streak-display">&#128293;0</span>
      </div>
    </div>
    <div class="worlds-container" id="worlds-container"></div>
  </div>

  <!-- TOPIC SELECT -->
  <div id="topic-screen" class="screen">
    <button class="back-btn" onclick="G.showScreen('map-screen')">&#8592;</button>
    <div style="padding-top:50px;color:#fff;text-align:center">
      <h2 id="world-title" style="font-family:'Fredoka One',sans-serif;color:var(--mc-gold)"></h2>
    </div>
    <div class="topics-grid" id="topics-grid"></div>
  </div>

  <!-- BATTLE SCREEN -->
  <div id="battle-screen" class="screen">
    <div class="battle-header">
      <div class="battle-info"><span id="battle-topic-name"></span></div>
      <div class="battle-info"><span id="battle-question-num"></span></div>
    </div>
    <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
    <div class="enemy-area">
      <div class="enemy-name" id="enemy-name"></div>
      <div class="enemy-hp-bar"><div class="enemy-hp-fill" id="enemy-hp-fill" style="width:100%"></div></div>
      <div class="enemy-sprite" id="enemy-sprite"></div>
    </div>
    <div class="question-area">
      <div class="question-text" id="question-text"></div>
      <div class="answers-grid" id="answers-grid"></div>
      <div class="number-input-area" id="number-input-area" style="display:none">
        <input type="text" class="number-input" id="number-input" inputmode="decimal" autocomplete="off">
        <button class="submit-answer-btn" onclick="G.submitTypedAnswer()">&#10003;</button>
      </div>
    </div>
    <div class="player-battle-area">
      <div class="player-sprite" id="player-sprite-el">&#9876;&#65039;</div>
      <div class="combo-display">
        <div id="combo-text"></div>
        <div id="streak-battle"></div>
      </div>
    </div>
  </div>

  <!-- RESULTS SCREEN -->
  <div id="results-screen" class="screen">
    <div class="results-title" id="results-title">VICTORY!</div>
    <div class="results-stats" id="results-stats"></div>
    <div class="rewards-area" id="rewards-area"></div>
    <button class="btn btn-green" onclick="G.showScreen('topic-screen')">Continue</button>
    <button class="btn btn-blue" onclick="G.replayBattle()">Play Again</button>
  </div>

  <!-- STATS SCREEN -->
  <div id="stats-screen" class="screen">
    <button class="back-btn" onclick="G.showScreen('title-screen')">&#8592;</button>
    <div class="stats-content" id="stats-content"></div>
  </div>

  <!-- STREAK BANNER -->
  <div class="streak-banner" id="streak-banner"></div>

  <!-- LEVEL UP OVERLAY -->
  <div class="level-up-overlay" id="level-up-overlay">
    <div class="level-up-box" id="level-up-box"></div>
  </div>
</div>

<script>
// ============================================================
// MATHSKILLZ - Henry's Epic Math Adventure
// Full NZ Year 4 Curriculum Game
// ============================================================

const G = (() => {
  // ---- AUDIO (Web Audio API synth) ----
  let audioCtx = null;
  function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
  function playTone(freq, dur, type='square', vol=0.15) {
    try {
      initAudio();
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.setValueAtTime(vol, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + dur);
    } catch(e) {}
  }
  function sfxCorrect() { playTone(523,0.1); setTimeout(()=>playTone(659,0.1),100); setTimeout(()=>playTone(784,0.15),200); }
  function sfxWrong() { playTone(200,0.2,'sawtooth',0.1); setTimeout(()=>playTone(150,0.3,'sawtooth',0.1),150); }
  function sfxLevelUp() { [523,659,784,1047].forEach((f,i)=>setTimeout(()=>playTone(f,0.15,'square',0.12),i*120)); }
  function sfxClick() { playTone(440,0.05,'square',0.08); }
  function sfxBoss() { playTone(110,0.3,'sawtooth',0.1); setTimeout(()=>playTone(130,0.3,'sawtooth',0.1),200); }

  // ---- SAVE/LOAD ----
  const SAVE_KEY = 'mathskillz_henry_v2';
  function defaultSave() {
    return {
      playerName: 'Henry', level: 1, xp: 0, totalXp: 0,
      streak: 0, bestStreak: 0, lastPlayDate: null,
      belt: 0, // 0=white,1=yellow,2=orange,3=green,4=blue,5=red,6=black
      topicProgress: {}, // topicId -> {completed,stars,bestScore,attempts}
      collection: [], // creature IDs collected
      achievements: [], // achievement IDs earned
      totalCorrect: 0, totalAnswered: 0, totalBattles: 0,
    };
  }
  let save = defaultSave();
  function loadGame() {
    try {
      const d = JSON.parse(localStorage.getItem(SAVE_KEY));
      if (d) save = { ...defaultSave(), ...d };
    } catch(e) {}
  }
  function saveGame() {
    try { localStorage.setItem(SAVE_KEY, JSON.stringify(save)); } catch(e) {}
  }

  // ---- CONSTANTS ----
  const BELTS = [
    {name:'White Belt',color:'#fff',emoji:'&#129399;'},
    {name:'Yellow Belt',color:'#FFD700',emoji:'&#129399;'},
    {name:'Orange Belt',color:'#FF8C00',emoji:'&#129399;'},
    {name:'Green Belt',color:'#2ecc71',emoji:'&#129399;'},
    {name:'Blue Belt',color:'#3498db',emoji:'&#129399;'},
    {name:'Red Belt',color:'#e74c3c',emoji:'&#129399;'},
    {name:'Black Belt',color:'#1a1a1a',emoji:'&#129399;'},
  ];

  const CREATURES = [
    {id:'c1',name:'Numbat',emoji:'&#128049;',desc:'Number apprentice'},
    {id:'c2',name:'Addax',emoji:'&#128046;',desc:'Addition master'},
    {id:'c3',name:'Subtracto',emoji:'&#128058;',desc:'Subtraction expert'},
    {id:'c4',name:'Multimouse',emoji:'&#128045;',desc:'Multiplication fury'},
    {id:'c5',name:'Divibear',emoji:'&#128059;',desc:'Division power'},
    {id:'c6',name:'Fractal Fox',emoji:'&#129418;',desc:'Fraction wizard'},
    {id:'c7',name:'Decimalion',emoji:'&#128009;',desc:'Decimal dragon'},
    {id:'c8',name:'Algebrawl',emoji:'&#129409;',desc:'Pattern seeker'},
    {id:'c9',name:'Metryx',emoji:'&#129412;',desc:'Measurement beast'},
    {id:'c10',name:'Geomancer',emoji:'&#128025;',desc:'Shape shifter'},
    {id:'c11',name:'Statistix',emoji:'&#129417;',desc:'Data cruncher'},
    {id:'c12',name:'CoinCobra',emoji:'&#128013;',desc:'Money master'},
    {id:'c13',name:'TimeTiger',emoji:'&#128005;',desc:'Time keeper'},
    {id:'c14',name:'AngleEagle',emoji:'&#129413;',desc:'Angle ace'},
    {id:'c15',name:'GridGriffin',emoji:'&#129420;',desc:'Grid navigator'},
  ];

  const ENEMIES = [
    {name:'Wild Mathling',emoji:'&#128126;',hp:3},
    {name:'Number Goblin',emoji:'&#128123;',hp:4},
    {name:'Fraction Phantom',emoji:'&#128123;',hp:5},
    {name:'Decimal Demon',emoji:'&#128520;',hp:5},
    {name:'Pattern Poltergeist',emoji:'&#128123;',hp:4},
    {name:'Measure Monster',emoji:'&#128122;',hp:5},
    {name:'Shape Shifter',emoji:'&#128125;',hp:4},
    {name:'Data Dragon',emoji:'&#128009;',hp:5},
    {name:'BOSS: Mathmagician',emoji:'&#129497;',hp:8},
  ];

  const XP_PER_LEVEL = level => 80 + level * 20;

  // ---- CURRICULUM WORLDS & TOPICS ----
  const WORLDS = [
    {
      id:'number', name:'Number Realm', emoji:'&#128290;', color:'#e74c3c',
      bg:'linear-gradient(135deg,#2c1810,#4a1a0a)',
      desc:'Master numbers, operations & fractions',
      topics: [
        {id:'placevalue',name:'Place Value',desc:'Numbers up to 10,000',icon:'&#127968;',questions:generatePlaceValue},
        {id:'rounding',name:'Rounding',desc:'Round to nearest 10, 100, 1000',icon:'&#128200;',questions:generateRounding},
        {id:'skipcounting',name:'Skip Counting',desc:'Count in 2s, 3s, 5s and more',icon:'&#128131;',questions:generateSkipCounting},
        {id:'addition',name:'Addition',desc:'Add up to 4-digit numbers',icon:'&#10133;',questions:generateAddition},
        {id:'subtraction',name:'Subtraction',desc:'Subtract up to 4-digit numbers',icon:'&#10134;',questions:generateSubtraction},
        {id:'timestables',name:'Times Tables',desc:'Multiply 2s through 10s',icon:'&#10006;',questions:generateTimesTable},
        {id:'division',name:'Division',desc:'Division facts & dividing',icon:'&#10135;',questions:generateDivision},
        {id:'bigmultiply',name:'Big Multiply',desc:'2-3 digit x 1 digit',icon:'&#128170;',questions:generateBigMultiply},
        {id:'bigdivide',name:'Big Divide',desc:'Divide up to 3 digits',icon:'&#128171;',questions:generateBigDivide},
        {id:'tenths',name:'Tenths',desc:'Fractions & decimals as tenths',icon:'&#128311;',questions:generateTenths},
        {id:'comparefracs',name:'Compare Fractions',desc:'Order fractions & decimals',icon:'&#9878;',questions:generateCompareFractions},
        {id:'equivfracs',name:'Equivalent Fractions',desc:'Find equal fractions',icon:'&#128256;',questions:generateEquivFractions},
        {id:'addfrac',name:'Add/Sub Fractions',desc:'Same denominator',icon:'&#127860;',questions:generateAddFractions},
        {id:'adddecimals',name:'Add/Sub Decimals',desc:'One decimal place',icon:'&#128178;',questions:generateAddDecimals},
        {id:'scaling',name:'Scaling',desc:'Double, halve & scale',icon:'&#128296;',questions:generateScaling},
        {id:'unitfrac',name:'Unit Fractions',desc:'Find fraction of a number',icon:'&#127829;',questions:generateUnitFractions},
        {id:'money',name:'NZ Money',desc:'Dollars, cents & change',icon:'&#128176;',questions:generateMoney},
      ]
    },
    {
      id:'algebra', name:'Algebra Tower', emoji:'&#9878;&#65039;', color:'#9b59b6',
      bg:'linear-gradient(135deg,#1a0a2e,#2d1b4e)',
      desc:'Patterns, equations & balance',
      topics: [
        {id:'compare',name:'Compare Numbers',desc:'Greater, less, or equal',icon:'&#9878;',questions:generateCompare},
        {id:'truefalse',name:'True or False',desc:'Check number sentences',icon:'&#10004;',questions:generateTrueFalse},
        {id:'missingnumber',name:'Missing Number',desc:'Find the unknown',icon:'&#10067;',questions:generateMissingNumber},
        {id:'patterns',name:'Growing Patterns',desc:'Find the rule & continue',icon:'&#128200;',questions:generatePatterns},
      ]
    },
    {
      id:'measurement', name:'Measure Mountain', emoji:'&#128207;', color:'#2ecc71',
      bg:'linear-gradient(135deg,#0a2e1a,#1b4e2d)',
      desc:'Length, mass, area, time & angles',
      topics: [
        {id:'estimation',name:'Estimation',desc:'Estimate with benchmarks',icon:'&#129504;',questions:generateEstimation},
        {id:'mixedunits',name:'Mixed Units',desc:'Length, mass & capacity',icon:'&#128207;',questions:generateMixedUnits},
        {id:'temperature',name:'Temperature',desc:'Degrees Celsius',icon:'&#127777;',questions:generateTemperature},
        {id:'perimeter',name:'Perimeter',desc:'Around the edge',icon:'&#128311;',questions:generatePerimeter},
        {id:'area',name:'Area',desc:'Rectangle areas',icon:'&#11036;',questions:generateArea},
        {id:'volume',name:'Volume',desc:'Filling 3D shapes',icon:'&#128230;',questions:generateVolume},
        {id:'angles',name:'Angles',desc:'Estimate & compare angles',icon:'&#128208;',questions:generateAngles},
        {id:'time',name:'Telling Time',desc:'Read clocks to the minute',icon:'&#128336;',questions:generateTime},
        {id:'duration',name:'Duration',desc:'How long does it take?',icon:'&#9201;',questions:generateDuration},
      ]
    },
    {
      id:'geometry', name:'Shape Fortress', emoji:'&#128312;', color:'#3498db',
      bg:'linear-gradient(135deg,#0a1a2e,#1b2d4e)',
      desc:'Shapes, symmetry & transformations',
      topics: [
        {id:'polygons',name:'Polygons',desc:'Shapes up to 12 sides',icon:'&#128310;',questions:generatePolygons},
        {id:'symmetry',name:'Symmetry',desc:'Lines of symmetry',icon:'&#128166;',questions:generateSymmetry},
        {id:'shapes3d',name:'3D Shapes',desc:'Visualise & describe',icon:'&#128230;',questions:generateShapes3D},
        {id:'transformations',name:'Transformations',desc:'Reflect, translate, rotate',icon:'&#128260;',questions:generateTransformations},
        {id:'gridrefs',name:'Grid References',desc:'Find positions on maps',icon:'&#128506;',questions:generateGridRefs},
      ]
    },
    {
      id:'statistics', name:'Data Dungeon', emoji:'&#128202;', color:'#e67e22',
      bg:'linear-gradient(135deg,#2e1a0a,#4e2d1b)',
      desc:'Collect, visualise & interpret data',
      topics: [
        {id:'variables',name:'Variables',desc:'Types of data',icon:'&#128203;',questions:generateVariables},
        {id:'dotplots',name:'Dot Plots',desc:'Create & read dot plots',icon:'&#128200;',questions:generateDotPlots},
        {id:'bargraphs',name:'Bar Graphs',desc:'Create & read bar graphs',icon:'&#128202;',questions:generateBarGraphs},
        {id:'interpret',name:'Interpret Data',desc:'What does the data show?',icon:'&#128269;',questions:generateInterpretData},
      ]
    },
  ];

  // ---- QUESTION GENERATORS ----
  function rnd(a,b) { return Math.floor(Math.random()*(b-a+1))+a; }
  function shuffle(a) { for(let i=a.length-1;i>0;i--){const j=rnd(0,i);[a[i],a[j]]=[a[j],a[i]];} return a; }
  function mcq(q, correct, distractors) {
    // Deduplicate: remove distractors that match the correct answer or each other
    const seen = new Set([String(correct)]);
    const uniqueDistractors = [];
    for (const d of distractors) {
      const s = String(d);
      if (!seen.has(s)) { seen.add(s); uniqueDistractors.push(d); }
      if (uniqueDistractors.length >= 3) break;
    }
    // Fill remaining slots if needed
    const numVal = typeof correct === 'number' ? correct : parseFloat(correct);
    if (!isNaN(numVal)) {
      let offset = 1;
      while (uniqueDistractors.length < 3) {
        const candidate = numVal + offset * (offset % 2 === 0 ? 1 : -1) * (Math.floor(offset/2) + 1) * 7;
        const s = String(candidate);
        if (!seen.has(s)) { seen.add(s); uniqueDistractors.push(candidate); }
        offset++;
      }
    } else {
      // For string answers, add placeholder distractors
      const fallbacks = ['???','N/A','None'];
      for (const fb of fallbacks) {
        if (uniqueDistractors.length >= 3) break;
        if (!seen.has(fb)) { seen.add(fb); uniqueDistractors.push(fb); }
      }
    }
    const opts = shuffle([correct, ...uniqueDistractors.slice(0,3)]);
    return {question:q, answer:String(correct), options:opts.map(String), type:'choice'};
  }
  function typed(q, correct) {
    return {question:q, answer:String(correct), type:'typed'};
  }

  function generatePlaceValue(diff) {
    const qs = [];
    for(let i=0;i<10;i++){
      const t = rnd(0,3);
      if(t===0){
        const n=rnd(100,9999);
        const digit=diff<3?'hundreds':'thousands';
        const pos=digit==='hundreds'?Math.floor(n/100)%10:Math.floor(n/1000);
        // Generate unique digit distractors
        const digs = shuffle([0,1,2,3,4,5,6,7,8,9].filter(d=>d!==pos)).slice(0,3);
        qs.push(mcq(`What digit is in the ${digit} place of ${n.toLocaleString()}?`,pos,digs));
      } else if(t===1){
        const a=rnd(100,9999),b=rnd(100,9999);
        while(a===b){b=rnd(100,9999);}
        const bigger=Math.max(a,b);
        qs.push(mcq(`Which is bigger: ${a.toLocaleString()} or ${b.toLocaleString()}?`,bigger,[Math.min(a,b),rnd(100,9999),rnd(100,9999)]));
      } else if(t===2){
        const th=rnd(1,9),h=rnd(0,9),te=rnd(0,9),o=rnd(0,9);
        const n=th*1000+h*100+te*10+o;
        qs.push(mcq(`${th} thousands + ${h} hundreds + ${te} tens + ${o} ones = ?`,n,[n+100,n-10,n+1000]));
      } else {
        const n=rnd(1000,9999);
        const expanded=`${Math.floor(n/1000)}000 + ${Math.floor(n/100)%10*100} + ${Math.floor(n/10)%10*10} + ${n%10}`;
        qs.push(mcq(`What number is ${expanded}?`,n,[n+111,n-99,n+10]));
      }
    }
    return qs;
  }

  function generateRounding(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,2);
      if(t===0){const n=rnd(11,999);const r=Math.round(n/10)*10;qs.push(mcq(`Round ${n} to the nearest 10`,r,[r+10,r-10,r+20]));}
      else if(t===1){const n=rnd(50,9950);const r=Math.round(n/100)*100;qs.push(mcq(`Round ${n} to the nearest 100`,r,[r+100,r-100,r+200]));}
      else{const n=rnd(500,9500);const r=Math.round(n/1000)*1000;qs.push(mcq(`Round ${n.toLocaleString()} to the nearest 1000`,r,[r+1000,r-1000,r+2000]));}
    }
    return qs;
  }

  function generateSkipCounting(diff) {
    const qs=[];
    const skips=diff<2?[2,5,10]:(diff<4?[2,3,4,5,10]:[2,3,4,5,6,7,8,9,25,50]);
    for(let i=0;i<10;i++){
      const s=skips[rnd(0,skips.length-1)];
      const start=s*rnd(1,5);
      const seq=[start,start+s,start+2*s];
      const ans=start+3*s;
      qs.push(mcq(`${seq.join(', ')}, ?  (counting by ${s}s)`,ans,[ans+s,ans-s,ans+1]));
    }
    return qs;
  }

  function generateAddition(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      let a,b;
      if(diff<2){a=rnd(10,99);b=rnd(10,99);}
      else if(diff<4){a=rnd(100,999);b=rnd(100,999);}
      else{a=rnd(1000,4999);b=rnd(1000,4999);}
      const ans=a+b;
      qs.push(mcq(`${a.toLocaleString()} + ${b.toLocaleString()} = ?`,ans,[ans+10,ans-10,ans+1]));
    }
    return qs;
  }

  function generateSubtraction(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      let a,b;
      if(diff<2){a=rnd(20,99);b=rnd(10,a-1);}
      else if(diff<4){a=rnd(200,999);b=rnd(100,a-1);}
      else{a=rnd(2000,9999);b=rnd(1000,a-1);}
      const ans=a-b;
      qs.push(mcq(`${a.toLocaleString()} - ${b.toLocaleString()} = ?`,ans,[ans+10,ans-10,ans+1]));
    }
    return qs;
  }

  function generateTimesTable(diff) {
    const qs=[];
    const tables=diff<2?[2,5,10]:(diff<4?[2,3,4,5,6,10]:[2,3,4,5,6,7,8,9,10]);
    for(let i=0;i<10;i++){
      const t=tables[rnd(0,tables.length-1)];
      const m=rnd(2,10);
      const ans=t*m;
      qs.push(mcq(`${t} x ${m} = ?`,ans,[ans+t,ans-t,ans+m]));
    }
    return qs;
  }

  function generateDivision(diff) {
    const qs=[];
    const divs=diff<2?[2,5,10]:(diff<4?[2,3,4,5,10]:[2,3,4,5,6,7,8,9,10]);
    for(let i=0;i<10;i++){
      const d=divs[rnd(0,divs.length-1)];
      const ans=rnd(2,10);
      const product=d*ans;
      qs.push(mcq(`${product} ÷ ${d} = ?`,ans,[ans+1,ans-1,ans+2]));
    }
    return qs;
  }

  function generateBigMultiply(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const a=diff<3?rnd(11,99):rnd(100,999);
      const b=rnd(2,9);
      const ans=a*b;
      qs.push(typed(`${a} x ${b} = ?`,ans));
    }
    return qs;
  }

  function generateBigDivide(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const d=rnd(2,9);
      const ans=diff<3?rnd(10,50):rnd(10,99);
      const product=d*ans;
      qs.push(typed(`${product} ÷ ${d} = ?`,ans));
    }
    return qs;
  }

  function generateTenths(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,2);
      if(t===0){
        const n=rnd(1,9);
        qs.push(mcq(`What is ${n}/10 as a decimal?`,`0.${n}`,[`0.${(n+1)%10}`,`${n}.0`,`0.0${n}`]));
      } else if(t===1){
        const n=rnd(1,99);
        const ans=(n/10).toFixed(1);
        qs.push(mcq(`${n} ÷ 10 = ?`,ans,[(n/10+1).toFixed(1),(n/10-0.1).toFixed(1),(n*10).toString()]));
      } else {
        const n=rnd(1,9);
        const ans=n*10;
        qs.push(mcq(`0.${n} x 10 = ?`,ans,[n,ans+10,ans-1]));
      }
    }
    return qs;
  }

  function generateCompareFractions(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      if(t===0){
        const d=rnd(3,10);
        const a=rnd(1,d-2),b=rnd(a+1,d-1);
        qs.push(mcq(`Which is bigger: ${a}/${d} or ${b}/${d}?`,`${b}/${d}`,[`${a}/${d}`,`They're equal`,`${a+b}/${d}`]));
      } else {
        const n=rnd(1,3);
        const d1=rnd(3,6),d2=rnd(d1+1,10);
        qs.push(mcq(`Which is bigger: ${n}/${d1} or ${n}/${d2}?`,`${n}/${d1}`,[`${n}/${d2}`,`They're equal`,`${n}/${d1+d2}`]));
      }
    }
    return qs;
  }

  function generateEquivFractions(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const n=rnd(1,4),d=rnd(n+1,6);
      const m=rnd(2,4);
      qs.push(mcq(`${n}/${d} = ${n*m}/?`,d*m,[d*m+1,d*m-1,d*(m+1)]));
    }
    return qs;
  }

  function generateAddFractions(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const d=rnd(3,8);
      const a=rnd(1,d-1),b=rnd(1,d-1);
      const sum=a+b;
      if(sum<=d){
        qs.push(mcq(`${a}/${d} + ${b}/${d} = ?`,`${sum}/${d}`,[`${sum}/${d*2}`,`${a+b+1}/${d}`,`${a}/${d+b}`]));
      } else {
        const whole=Math.floor(sum/d),rem=sum%d;
        const ans=rem===0?`${whole}`:`${whole} ${rem}/${d}`;
        qs.push(mcq(`${a}/${d} + ${b}/${d} = ?`,ans,[`${sum}/${d*2}`,`${sum+1}/${d}`,`${a}/${d}`]));
      }
    }
    return qs;
  }

  function generateAddDecimals(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const a=rnd(1,99)/10, b=rnd(1,99)/10;
      const ans=+(a+b).toFixed(1);
      qs.push(mcq(`${a.toFixed(1)} + ${b.toFixed(1)} = ?`,ans.toFixed(1),
        [(ans+0.1).toFixed(1),(ans-0.1).toFixed(1),(ans+1).toFixed(1)]));
    }
    return qs;
  }

  function generateScaling(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      if(t===0){const n=rnd(2,50)*2;const ans=n/2;qs.push(mcq(`Half of ${n} = ?`,ans,[ans+1,ans-1,ans*2]));}
      else{const n=rnd(2,50);const ans=n*2;qs.push(mcq(`Double ${n} = ?`,ans,[ans+1,ans-2,ans+10]));}
    }
    return qs;
  }

  function generateUnitFractions(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      if(t===0){
        const d=rnd(2,5);
        const ans=rnd(5,20);
        const whole=d*ans;
        qs.push(mcq(`1/${d} of ${whole} = ?`,ans,[ans+d,ans-1,ans*2]));
      } else {
        const d=rnd(2,5);
        const part=rnd(3,15);
        const whole=part*d;
        qs.push(mcq(`1/${d} of a set is ${part}. What is the whole set?`,whole,[whole+part,whole-part,part]));
      }
    }
    return qs;
  }

  function generateMoney(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,2);
      if(t===0){
        const items=[rnd(2,20),rnd(1,15),rnd(3,25)];
        const ans=items.reduce((a,b)=>a+b,0);
        qs.push(mcq(`Items cost $${items[0]}, $${items[1]}, $${items[2]}. Total = ?`,`$${ans}`,[`$${ans+5}`,`$${ans-3}`,`$${ans+10}`]));
      } else if(t===1){
        const cost=rnd(3,18);
        const paid=rnd(cost+1,cost+10);
        const change=paid-cost;
        qs.push(mcq(`You pay $${paid} for a $${cost} item. Change = ?`,`$${change}`,[`$${change+1}`,`$${change-1}`,`$${paid}`]));
      } else {
        const qty=rnd(2,5);
        const price=rnd(2,10);
        const ans=qty*price;
        qs.push(mcq(`${qty} items at $${price} each = ?`,`$${ans}`,[`$${ans+price}`,`$${ans-price}`,`$${qty+price}`]));
      }
    }
    return qs;
  }

  function generateCompare(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      let a=rnd(10,9999),b=rnd(10,9999);
      while(a===b) b=rnd(10,9999);
      const correct=a>b?'>':'<';
      // Always provide all 3 symbols plus one variation
      qs.push({
        question:`${a.toLocaleString()} ? ${b.toLocaleString()}`,
        answer:correct,
        options:shuffle(['>','<','=',correct==='>'?'≤':'≥']),
        type:'choice'
      });
    }
    return qs;
  }

  function generateTrueFalse(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      if(t===0){
        const a=rnd(10,500),b=rnd(10,500);
        const isAdd=rnd(0,1);
        const result=isAdd?a+b:a-b;
        const offset=rnd(0,1)?0:rnd(1,5)*(rnd(0,1)?1:-1);
        const shown=result+offset;
        const correct=offset===0?'True':'False';
        const op=isAdd?'+':'-';
        qs.push({question:`${a} ${op} ${b} = ${shown}. True or False?`,answer:correct,options:shuffle(['True','False','Not sure','Almost']),type:'choice'});
      } else {
        const a=rnd(2,10),b=rnd(2,10);
        const result=a*b;
        const offset=rnd(0,1)?0:rnd(1,3)*(rnd(0,1)?1:-1);
        const shown=result+offset;
        const correct=offset===0?'True':'False';
        qs.push({question:`${a} x ${b} = ${shown}. True or False?`,answer:correct,options:shuffle(['True','False','Not sure','Almost']),type:'choice'});
      }
    }
    return qs;
  }

  function generateMissingNumber(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,3);
      if(t===0){const a=rnd(10,500),b=rnd(10,500);qs.push(typed(`${a} + ? = ${a+b}`,b));}
      else if(t===1){const a=rnd(100,999),b=rnd(10,a-1);qs.push(typed(`${a} - ? = ${a-b}`,b));}
      else if(t===2){const a=rnd(2,10),b=rnd(2,10);qs.push(typed(`${a} x ? = ${a*b}`,b));}
      else{const a=rnd(2,10),b=rnd(2,10);qs.push(typed(`? ÷ ${a} = ${b}`,a*b));}
    }
    return qs;
  }

  function generatePatterns(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      if(t===0){
        const step=rnd(2,9);
        const start=rnd(1,20);
        const seq=[start,start+step,start+2*step,start+3*step];
        const ans=start+4*step;
        qs.push(mcq(`${seq.join(', ')}, ?  What comes next?`,ans,[ans+step,ans-step,ans+1]));
      } else {
        const mult=rnd(2,3);
        const start=rnd(1,5);
        const seq=[start,start*mult,start*mult*mult];
        const ans=start*mult*mult*mult;
        qs.push(mcq(`${seq.join(', ')}, ?  What comes next?`,ans,[ans+mult,ans*2,ans-mult]));
      }
    }
    return qs;
  }

  function generateEstimation(diff) {
    const qs=[];
    const benchmarks=[
      {q:'About how long is your hand span?',a:'20 cm',d:['2 cm','200 cm','20 m']},
      {q:'About how tall is a door?',a:'2 m',d:['20 cm','20 m','200 cm']},
      {q:'About how much does a bag of sugar weigh?',a:'1 kg',d:['1 g','100 g','10 kg']},
      {q:'About how much water in a jug?',a:'1 L',d:['1 mL','100 mL','10 L']},
      {q:'About how long is a pencil?',a:'18 cm',d:['18 mm','18 m','180 cm']},
      {q:'About how heavy is an apple?',a:'150 g',d:['15 g','1.5 kg','150 kg']},
      {q:'How long does it take to walk 1 km?',a:'15 minutes',d:['1 minute','1 hour','15 seconds']},
      {q:'About how wide is your thumbnail?',a:'1 cm',d:['1 mm','10 cm','1 m']},
      {q:'About how much does a cat weigh?',a:'4 kg',d:['400 g','40 kg','4 g']},
      {q:'About how hot is a warm bath?',a:'38°C',d:['10°C','80°C','100°C']},
    ];
    shuffle(benchmarks);
    for(let i=0;i<Math.min(10,benchmarks.length);i++){
      const b=benchmarks[i];
      qs.push(mcq(b.q,b.a,b.d));
    }
    return qs;
  }

  function generateMixedUnits(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,2);
      if(t===0){
        const m=rnd(1,5),cm=rnd(10,99);
        const totalcm=m*100+cm;
        qs.push(mcq(`${m} m and ${cm} cm = ? cm`,totalcm,[totalcm+10,totalcm-100,m+cm]));
      } else if(t===1){
        const kg=rnd(1,9),g=rnd(100,900);
        const totalg=kg*1000+g;
        qs.push(mcq(`${kg} kg and ${g} g = ? g`,totalg,[totalg+1000,kg+g,totalg-100]));
      } else {
        const l=rnd(1,5),ml=rnd(100,900);
        const totalml=l*1000+ml;
        qs.push(mcq(`${l} L and ${ml} mL = ? mL`,totalml,[totalml+500,l+ml,totalml-1000]));
      }
    }
    return qs;
  }

  function generateTemperature(diff) {
    const qs=[];
    const scenarios=[
      {q:'Water freezes at what temperature?',a:'0°C',d:['10°C','100°C','-10°C']},
      {q:'Water boils at what temperature?',a:'100°C',d:['0°C','50°C','200°C']},
      {q:'A comfortable room is about?',a:'20°C',d:['5°C','35°C','50°C']},
      {q:'A hot summer day might be?',a:'30°C',d:['10°C','50°C','0°C']},
      {q:'A cold winter day might be?',a:'5°C',d:['25°C','-20°C','40°C']},
    ];
    for(let i=0;i<10;i++){
      if(i<scenarios.length){qs.push(mcq(scenarios[i].q,scenarios[i].a,scenarios[i].d));}
      else{
        const start=rnd(5,30),change=rnd(3,15);
        const op=rnd(0,1);
        if(op===0){qs.push(mcq(`Temperature is ${start}°C, rises ${change}°C. Now?`,`${start+change}°C`,[`${start-change}°C`,`${change}°C`,`${start}°C`]));}
        else{qs.push(mcq(`Temperature is ${start}°C, drops ${change}°C. Now?`,`${start-change}°C`,[`${start+change}°C`,`${change}°C`,`${start}°C`]));}
      }
    }
    return qs;
  }

  function generatePerimeter(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      if(t===0){
        const w=rnd(3,20),h=rnd(3,20);
        const p=2*(w+h);
        qs.push(mcq(`Rectangle: ${w} cm x ${h} cm. Perimeter = ?`,`${p} cm`,[`${w*h} cm`,`${w+h} cm`,`${p+2} cm`]));
      } else {
        const s=rnd(3,15);
        const p=4*s;
        qs.push(mcq(`Square: side = ${s} cm. Perimeter = ?`,`${p} cm`,[`${s*s} cm`,`${s*2} cm`,`${p+s} cm`]));
      }
    }
    return qs;
  }

  function generateArea(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const w=rnd(2,12),h=rnd(2,12);
      const a=w*h;
      qs.push(mcq(`Rectangle: ${w} cm x ${h} cm. Area = ?`,`${a} cm²`,[`${2*(w+h)} cm²`,`${a+w} cm²`,`${w+h} cm²`]));
    }
    return qs;
  }

  function generateVolume(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const l=rnd(2,6),w=rnd(2,6),h=rnd(2,6);
      const v=l*w*h;
      qs.push(mcq(`Box: ${l} x ${w} x ${h} blocks. Volume = ? blocks`,v,[v+l,v-w,l*w+h]));
    }
    return qs;
  }

  function generateAngles(diff) {
    const qs=[];
    const types=[
      {q:'A right angle is how many degrees?',a:'90°',d:['45°','180°','360°']},
      {q:'A straight line angle is how many degrees?',a:'180°',d:['90°','360°','270°']},
      {q:'A full turn is how many degrees?',a:'360°',d:['180°','90°','270°']},
      {q:'An angle smaller than 90° is called?',a:'Acute',d:['Obtuse','Right','Reflex']},
      {q:'An angle larger than 90° but less than 180° is called?',a:'Obtuse',d:['Acute','Right','Reflex']},
    ];
    for(let i=0;i<10;i++){
      if(i<types.length){qs.push(mcq(types[i].q,types[i].a,types[i].d));}
      else{
        const angle=rnd(1,35)*10;
        const type=angle<90?'Acute':(angle===90?'Right':(angle<180?'Obtuse':'Reflex'));
        qs.push(mcq(`An angle of ${angle}° is...`,type,['Acute','Obtuse','Right','Reflex'].filter(t=>t!==type).slice(0,3)));
      }
    }
    return qs;
  }

  function generateTime(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const h=rnd(1,12),m=rnd(0,59);
      const mStr=m<10?`0${m}`:`${m}`;
      const period=rnd(0,1)?'am':'pm';
      if(rnd(0,1)){
        const mWord=m===0?`o'clock`:(m===15?'quarter past':(m===30?'half past':(m===45?'quarter to':`${m} minutes past`)));
        const display=m===45?`quarter to ${h===12?1:h+1}`:mWord+` ${h}`;
        qs.push(mcq(`What time is ${display}?`,`${h}:${mStr}`,
          [`${h===12?1:h+1}:${mStr}`,`${h}:${m<10?`${rnd(1,5)}0`:rnd(10,59)}`,`${rnd(1,12)}:${rnd(10,59)}`]));
      } else {
        qs.push(mcq(`${h}:${mStr} ${period} - How many minutes past ${h}?`,m,[m+15,m===0?30:m-5,m+5]));
      }
    }
    return qs;
  }

  function generateDuration(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const t=rnd(0,3);
      if(t===0){const w=rnd(1,5);qs.push(mcq(`${w} weeks = ? days`,w*7,[w*5,w*10,w*7+1]));}
      else if(t===1){const h=rnd(1,5);qs.push(mcq(`${h} hours = ? minutes`,h*60,[h*100,h*30,h*60+10]));}
      else if(t===2){const m=rnd(1,10);qs.push(mcq(`${m} minutes = ? seconds`,m*60,[m*100,m*30,m*60+10]));}
      else{const d=rnd(1,5);qs.push(mcq(`${d*24} hours = ? days`,d,[d*24,d+1,d*2]));}
    }
    return qs;
  }

  function generatePolygons(diff) {
    const qs=[];
    const shapes=[
      {name:'Triangle',sides:3},{name:'Quadrilateral',sides:4},{name:'Pentagon',sides:5},
      {name:'Hexagon',sides:6},{name:'Heptagon',sides:7},{name:'Octagon',sides:8},
      {name:'Nonagon',sides:9},{name:'Decagon',sides:10},{name:'Hendecagon',sides:11},{name:'Dodecagon',sides:12},
    ];
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      const s=shapes[rnd(0,shapes.length-1)];
      if(t===0){
        qs.push(mcq(`How many sides does a ${s.name} have?`,s.sides,
          [s.sides+1,s.sides-1,s.sides+2].filter(n=>n>0)));
      } else {
        qs.push(mcq(`A shape with ${s.sides} sides is called a?`,s.name,
          shuffle(shapes.filter(x=>x.name!==s.name).map(x=>x.name)).slice(0,3)));
      }
    }
    return qs;
  }

  function generateSymmetry(diff) {
    const qs=[];
    const shapes=[
      {name:'Square',lines:4},{name:'Rectangle',lines:2},{name:'Equilateral triangle',lines:3},
      {name:'Circle',lines:'Infinite'},{name:'Regular pentagon',lines:5},{name:'Regular hexagon',lines:6},
      {name:'Isosceles triangle',lines:1},
    ];
    for(let i=0;i<10;i++){
      const s=shapes[rnd(0,shapes.length-1)];
      qs.push(mcq(`How many lines of symmetry does a ${s.name} have?`,s.lines,
        [typeof s.lines==='number'?s.lines+1:1,typeof s.lines==='number'?Math.max(0,s.lines-1):0,typeof s.lines==='number'?s.lines+2:3]));
    }
    return qs;
  }

  function generateShapes3D(diff) {
    const qs=[];
    const shapes=[
      {name:'Cube',faces:6,edges:12,vertices:8},
      {name:'Rectangular prism (cuboid)',faces:6,edges:12,vertices:8},
      {name:'Triangular prism',faces:5,edges:9,vertices:6},
      {name:'Square pyramid',faces:5,edges:8,vertices:5},
      {name:'Cylinder',faces:3,edges:2,vertices:0},
      {name:'Sphere',faces:1,edges:0,vertices:0},
      {name:'Cone',faces:2,edges:1,vertices:1},
    ];
    for(let i=0;i<10;i++){
      const s=shapes[rnd(0,shapes.length-1)];
      const prop=['faces','edges','vertices'][rnd(0,2)];
      qs.push(mcq(`How many ${prop} does a ${s.name} have?`,s[prop],
        [s[prop]+1,Math.max(0,s[prop]-1),s[prop]+2]));
    }
    return qs;
  }

  function generateTransformations(diff) {
    const qs=[];
    const types=[
      {q:'Flipping a shape over a line is called a?',a:'Reflection',d:['Rotation','Translation','Enlargement']},
      {q:'Sliding a shape without turning it is called a?',a:'Translation',d:['Reflection','Rotation','Enlargement']},
      {q:'Turning a shape around a point is called a?',a:'Rotation',d:['Reflection','Translation','Enlargement']},
      {q:'A mirror image of a shape is a?',a:'Reflection',d:['Translation','Rotation','Scaling']},
      {q:'Moving a shape up and right without changing it is a?',a:'Translation',d:['Reflection','Rotation','Scaling']},
      {q:'A shape spun 90° clockwise is a?',a:'Rotation',d:['Reflection','Translation','Scaling']},
      {q:'Which keeps a shape the same size: reflection, rotation, or both?',a:'Both',d:['Reflection only','Rotation only','Neither']},
      {q:'A quarter turn = how many degrees?',a:'90°',d:['45°','180°','360°']},
      {q:'A half turn = how many degrees?',a:'180°',d:['90°','270°','360°']},
      {q:'How many quarter turns in a full turn?',a:'4',d:['2','3','6']},
    ];
    shuffle(types);
    for(let i=0;i<10;i++){
      const t=types[i%types.length];
      qs.push(mcq(t.q,t.a,t.d));
    }
    return qs;
  }

  function generateGridRefs(diff) {
    const qs=[];
    const letters='ABCDEFGH';
    for(let i=0;i<10;i++){
      const t=rnd(0,1);
      if(t===0){
        const r=letters[rnd(0,5)],c=rnd(1,6);
        qs.push(mcq(`On a grid, which reference is row ${r}, column ${c}?`,`${r}${c}`,
          [`${letters[rnd(0,5)]}${rnd(1,6)}`,`${c}${r}`,`${letters[rnd(0,5)]}${rnd(1,6)}`]));
      } else {
        const r=letters[rnd(0,5)],c=rnd(1,6);
        qs.push(mcq(`Grid reference ${r}${c}: what is the row letter?`,r,
          [letters[rnd(0,5)],letters[rnd(0,5)],String(c)].filter(x=>x!==r)));
      }
    }
    return qs;
  }

  function generateVariables(diff) {
    const qs=[];
    const examples=[
      {q:'Favourite colour is what type of variable?',a:'Categorical',d:['Discrete numerical','Continuous numerical','None']},
      {q:'Number of pets is what type of variable?',a:'Discrete numerical',d:['Categorical','Continuous numerical','None']},
      {q:'Height in cm is what type of variable?',a:'Continuous numerical',d:['Categorical','Discrete numerical','None']},
      {q:'Eye colour is what type of variable?',a:'Categorical',d:['Discrete numerical','Continuous numerical','None']},
      {q:'Number of siblings is what type?',a:'Discrete numerical',d:['Categorical','Continuous numerical','None']},
      {q:'Weight in kg is what type?',a:'Continuous numerical',d:['Categorical','Discrete numerical','None']},
      {q:'Type of transport to school is?',a:'Categorical',d:['Discrete numerical','Continuous numerical','None']},
      {q:'Number of skips in 30 seconds is?',a:'Discrete numerical',d:['Categorical','Continuous numerical','None']},
      {q:'Time to run 100m is?',a:'Continuous numerical',d:['Categorical','Discrete numerical','None']},
      {q:'Shoe brand is what type?',a:'Categorical',d:['Discrete numerical','Continuous numerical','None']},
    ];
    shuffle(examples);
    for(let i=0;i<10;i++) qs.push(mcq(examples[i%examples.length].q,examples[i%examples.length].a,examples[i%examples.length].d));
    return qs;
  }

  function generateDotPlots(diff) {
    const qs=[];
    for(let i=0;i<10;i++){
      const data=[];for(let j=0;j<15;j++)data.push(rnd(1,6));
      const mode=data.sort().reduce((a,b)=>{a[b]=(a[b]||0)+1;return a;},{});
      const modeVal=Object.entries(mode).sort((a,b)=>b[1]-a[1])[0];
      const t=rnd(0,1);
      if(t===0){
        qs.push(mcq(`Dot plot data: [${data.join(',')}]. Most common value?`,parseInt(modeVal[0]),
          [parseInt(modeVal[0])+1,parseInt(modeVal[0])-1,rnd(1,6)]));
      } else {
        const val=rnd(1,6);
        const count=data.filter(d=>d===val).length;
        qs.push(mcq(`Data: [${data.join(',')}]. How many times does ${val} appear?`,count,[count+1,Math.max(0,count-1),count+2]));
      }
    }
    return qs;
  }

  function generateBarGraphs(diff) {
    const qs=[];
    const categories=['Red','Blue','Green','Yellow','Purple'];
    for(let i=0;i<10;i++){
      const vals={};
      categories.forEach(c=>vals[c]=rnd(2,15));
      const t=rnd(0,2);
      if(t===0){
        const max=Object.entries(vals).sort((a,b)=>b[1]-a[1])[0];
        qs.push(mcq(`Bar graph shows: ${Object.entries(vals).map(([k,v])=>`${k}:${v}`).join(', ')}. Which has the most?`,max[0],
          categories.filter(c=>c!==max[0]).slice(0,3)));
      } else if(t===1){
        const cat=categories[rnd(0,4)];
        qs.push(mcq(`${Object.entries(vals).map(([k,v])=>`${k}:${v}`).join(', ')}. How many chose ${cat}?`,vals[cat],
          [vals[cat]+2,vals[cat]-1,vals[cat]+5]));
      } else {
        const total=Object.values(vals).reduce((a,b)=>a+b,0);
        qs.push(mcq(`${Object.entries(vals).map(([k,v])=>`${k}:${v}`).join(', ')}. Total responses?`,total,
          [total+5,total-3,total+10]));
      }
    }
    return qs;
  }

  function generateInterpretData(diff) {
    const qs=[];
    const scenarios=[
      {q:'In a dot plot, the "spread" tells us...',a:'How far apart the data is',d:['The most common value','The total count','The average']},
      {q:'The "middle group" in data means...',a:'Where most data clusters',d:['The first value','The last value','The total']},
      {q:'A dot plot with one tall peak means...',a:'Many items have the same value',d:['The data is spread out','There is no pattern','The data is wrong']},
      {q:'The minimum value in data is...',a:'The smallest value',d:['The biggest value','The middle value','The most common']},
      {q:'The maximum value in data is...',a:'The biggest value',d:['The smallest value','The middle value','The least common']},
      {q:'A good graph title should tell us...',a:'What the graph is about',d:['Who made it','When it was made','How big it is']},
      {q:'Graph axes should always include...',a:'Labels and units',d:['Colours only','Pictures only','Nothing extra']},
      {q:'Frequency in a graph means...',a:'How often something occurs',d:['How big something is','How old something is','How fast it goes']},
      {q:'A bar graph is best for showing...',a:'Categorical data counts',d:['Continuous data only','Time only','Weight only']},
      {q:'A dot plot is best for showing...',a:'Numerical data distribution',d:['Names only','Colours only','Dates only']},
    ];
    shuffle(scenarios);
    for(let i=0;i<10;i++){
      const s=scenarios[i%scenarios.length];
      qs.push(mcq(s.q,s.a,s.d));
    }
    return qs;
  }

  // ---- GAME STATE ----
  let currentWorld = null;
  let currentTopic = null;
  let battleState = null;
  let timerInterval = null;

  // ---- SCREEN MANAGEMENT ----
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'map-screen') renderMap();
    if (id === 'topic-screen') renderTopics();
    if (id === 'stats-screen') renderStats();
    sfxClick();
  }

  // ---- MAP RENDERING ----
  function renderMap() {
    updateHeader();
    const c = document.getElementById('worlds-container');
    c.innerHTML = '';
    WORLDS.forEach((w, wi) => {
      const unlocked = wi === 0 || isWorldUnlocked(wi);
      const progress = getWorldProgress(w);
      const card = document.createElement('div');
      card.className = `world-card pixel-border ${unlocked ? '' : 'locked'}`;
      card.style.background = w.bg;
      card.innerHTML = `
        <div class="world-icon">${w.emoji}</div>
        <div class="world-name">${w.name}</div>
        <div class="world-progress">${progress}% complete</div>
        ${unlocked ? '' : '<div class="lock-icon">&#128274;</div>'}
      `;
      if (unlocked) card.onclick = () => { currentWorld = w; showScreen('topic-screen'); };
      c.appendChild(card);
    });
  }

  function isWorldUnlocked(worldIndex) {
    if (worldIndex === 0) return true;
    const prevWorld = WORLDS[worldIndex - 1];
    const completed = prevWorld.topics.filter(t => {
      const p = save.topicProgress[t.id];
      return p && p.completed;
    }).length;
    return completed >= Math.ceil(prevWorld.topics.length * 0.5);
  }

  function getWorldProgress(world) {
    const total = world.topics.length;
    const done = world.topics.filter(t => save.topicProgress[t.id]?.completed).length;
    return Math.round(done / total * 100);
  }

  function updateHeader() {
    document.getElementById('level-display').textContent = `Lv.${save.level}`;
    const belt = BELTS[save.belt];
    document.getElementById('belt-display').innerHTML = `${belt.emoji} ${belt.name}`;
    const xpNeeded = XP_PER_LEVEL(save.level);
    const pct = Math.min(100, Math.round(save.xp / xpNeeded * 100));
    document.getElementById('xp-bar-fill').style.width = pct + '%';
    document.getElementById('xp-text').textContent = `${save.xp}/${xpNeeded}`;
    document.getElementById('streak-display').innerHTML = `&#128293;${save.streak}`;
  }

  // ---- TOPIC RENDERING ----
  function renderTopics() {
    if (!currentWorld) return;
    document.getElementById('world-title').innerHTML = `${currentWorld.emoji} ${currentWorld.name}`;
    const grid = document.getElementById('topics-grid');
    grid.innerHTML = '';
    currentWorld.topics.forEach((t, ti) => {
      const progress = save.topicProgress[t.id] || { completed: false, stars: 0, bestScore: 0, attempts: 0 };
      const unlocked = ti === 0 || (save.topicProgress[currentWorld.topics[ti - 1]?.id]?.completed);
      const row = document.createElement('div');
      row.className = `topic-row ${unlocked ? '' : 'locked'} ${progress.completed ? 'completed' : ''}`;
      row.innerHTML = `
        <div class="topic-icon">${t.icon}</div>
        <div class="topic-info">
          <div class="topic-name">${t.name}</div>
          <div class="topic-desc">${t.desc}</div>
        </div>
        <div class="topic-stars">${'&#11088;'.repeat(progress.stars)}${'&#9734;'.repeat(3 - progress.stars)}</div>
        ${!unlocked ? '<span>&#128274;</span>' : ''}
      `;
      if (unlocked) row.onclick = () => startBattle(t);
      grid.appendChild(row);
    });
  }

  // ---- BATTLE SYSTEM ----
  function startBattle(topic) {
    currentTopic = topic;
    const diff = (save.topicProgress[topic.id]?.attempts || 0);
    const questions = topic.questions(Math.min(diff, 5));
    const enemyTemplate = ENEMIES[rnd(0, ENEMIES.length - 2)];
    const isBoss = (save.topicProgress[topic.id]?.attempts || 0) >= 2;

    battleState = {
      questions: shuffle(questions).slice(0, 10),
      currentQ: 0,
      score: 0,
      combo: 0,
      maxCombo: 0,
      startTime: Date.now(),
      enemy: isBoss ? { ...ENEMIES[ENEMIES.length - 1] } : { ...enemyTemplate },
      enemyMaxHp: isBoss ? 8 : enemyTemplate.hp,
      enemyHp: isBoss ? 8 : enemyTemplate.hp,
      answered: false,
      timePerQ: 30,
      timeLeft: 30,
    };

    showScreen('battle-screen');
    document.getElementById('battle-topic-name').textContent = topic.name;
    if (isBoss) sfxBoss();
    showQuestion();
  }

  function showQuestion() {
    if (!battleState || battleState.currentQ >= battleState.questions.length) {
      endBattle();
      return;
    }
    battleState.answered = false;
    const q = battleState.questions[battleState.currentQ];
    document.getElementById('question-text').textContent = q.question;
    document.getElementById('battle-question-num').textContent = `${battleState.currentQ + 1}/${battleState.questions.length}`;
    document.getElementById('enemy-name').textContent = battleState.enemy.name;
    document.getElementById('enemy-sprite').innerHTML = battleState.enemy.emoji;
    document.getElementById('enemy-hp-fill').style.width = `${battleState.enemyHp / battleState.enemyMaxHp * 100}%`;
    document.getElementById('combo-text').textContent = battleState.combo > 1 ? `${battleState.combo}x COMBO!` : '';
    document.getElementById('streak-battle').innerHTML = `&#128293; ${save.streak} streak`;

    const answersGrid = document.getElementById('answers-grid');
    const inputArea = document.getElementById('number-input-area');
    const numInput = document.getElementById('number-input');

    if (q.type === 'typed') {
      answersGrid.style.display = 'none';
      inputArea.style.display = 'flex';
      numInput.value = '';
      numInput.focus();
    } else {
      answersGrid.style.display = 'grid';
      inputArea.style.display = 'none';
      answersGrid.innerHTML = '';
      q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(opt, btn);
        answersGrid.appendChild(btn);
      });
    }

    // Timer
    battleState.timeLeft = battleState.timePerQ;
    clearInterval(timerInterval);
    const timerFill = document.getElementById('timer-fill');
    timerFill.style.width = '100%';
    timerFill.classList.remove('urgent');
    timerInterval = setInterval(() => {
      battleState.timeLeft -= 0.1;
      const pct = Math.max(0, battleState.timeLeft / battleState.timePerQ * 100);
      timerFill.style.width = pct + '%';
      if (pct < 30) timerFill.classList.add('urgent');
      if (battleState.timeLeft <= 0) {
        clearInterval(timerInterval);
        if (!battleState.answered) timeOut();
      }
    }, 100);
  }

  function submitTypedAnswer() {
    if (battleState.answered) return;
    const input = document.getElementById('number-input');
    const val = input.value.trim();
    if (!val) return;
    checkAnswer(val, input);
  }

  function checkAnswer(answer, element) {
    if (battleState.answered) return;
    battleState.answered = true;
    clearInterval(timerInterval);

    const q = battleState.questions[battleState.currentQ];
    const correct = String(answer).trim() === String(q.answer).trim();

    save.totalAnswered++;
    if (correct) {
      save.totalCorrect++;
      battleState.score++;
      battleState.combo++;
      battleState.maxCombo = Math.max(battleState.maxCombo, battleState.combo);
      battleState.enemyHp = Math.max(0, battleState.enemyHp - 1);
      document.getElementById('enemy-hp-fill').style.width = `${battleState.enemyHp / battleState.enemyMaxHp * 100}%`;

      if (element.classList) element.classList.add('correct');
      sfxCorrect();

      // Damage float
      const sprite = document.getElementById('enemy-sprite');
      const float = document.createElement('div');
      float.className = 'damage-float';
      float.textContent = battleState.combo > 1 ? `-1 x${battleState.combo}` : '-1';
      float.style.left = '50%';
      float.style.top = '0';
      sprite.appendChild(float);
      setTimeout(() => float.remove(), 1000);

      // Hit effects
      sprite.classList.add('enemy-hit');
      setTimeout(() => sprite.classList.remove('enemy-hit'), 400);
      const rect = sprite.getBoundingClientRect();
      spawnParticles(rect.left + rect.width/2, rect.top + rect.height/2, '#FFD700', 20);

      // XP popup
      const xpPop = document.createElement('div');
      xpPop.className = 'xp-popup';
      xpPop.textContent = `+${10 + battleState.combo * 2} XP`;
      xpPop.style.left = '50%'; xpPop.style.bottom = '120px';
      document.getElementById('battle-screen').appendChild(xpPop);
      setTimeout(() => xpPop.remove(), 1500);
    } else {
      battleState.combo = 0;
      if (element.classList) element.classList.add('wrong');
      sfxWrong();
      // Screen shake
      document.getElementById('battle-screen').classList.add('screen-shake');
      setTimeout(() => document.getElementById('battle-screen').classList.remove('screen-shake'), 300);
      // Show correct answer
      if (q.type !== 'typed') {
        document.querySelectorAll('.answer-btn').forEach(btn => {
          if (btn.textContent === q.answer) btn.classList.add('correct');
        });
      }
    }

    battleState.currentQ++;
    setTimeout(() => showQuestion(), correct ? 800 : 1500);
    saveGame();
  }

  function timeOut() {
    battleState.answered = true;
    battleState.combo = 0;
    sfxWrong();
    const q = battleState.questions[battleState.currentQ];
    if (q.type !== 'typed') {
      document.querySelectorAll('.answer-btn').forEach(btn => {
        if (btn.textContent === q.answer) btn.classList.add('correct');
      });
    }
    battleState.currentQ++;
    setTimeout(() => showQuestion(), 1500);
  }

  function endBattle() {
    clearInterval(timerInterval);
    const total = battleState.questions.length;
    const score = battleState.score;
    const pct = Math.round(score / total * 100);
    const stars = pct >= 90 ? 3 : (pct >= 70 ? 2 : (pct >= 50 ? 1 : 0));
    const timeTaken = Math.round((Date.now() - battleState.startTime) / 1000);

    // XP calculation
    let xpEarned = score * 10 + battleState.maxCombo * 5;
    if (stars === 3) xpEarned += 20;

    // Update progress
    const prev = save.topicProgress[currentTopic.id] || { completed: false, stars: 0, bestScore: 0, attempts: 0 };
    save.topicProgress[currentTopic.id] = {
      completed: prev.completed || stars >= 1,
      stars: Math.max(prev.stars, stars),
      bestScore: Math.max(prev.bestScore, score),
      attempts: prev.attempts + 1,
    };
    save.totalBattles++;

    // Streak
    const today = new Date().toDateString();
    if (save.lastPlayDate !== today) {
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      save.streak = save.lastPlayDate === yesterday ? save.streak + 1 : 1;
      save.lastPlayDate = today;
    }
    save.bestStreak = Math.max(save.bestStreak, save.streak);

    // Add XP and check level up
    save.xp += xpEarned;
    save.totalXp += xpEarned;
    let leveled = false;
    while (save.xp >= XP_PER_LEVEL(save.level)) {
      save.xp -= XP_PER_LEVEL(save.level);
      save.level++;
      leveled = true;
    }

    // Belt progression
    const newBelt = Math.min(6, Math.floor(save.level / 5));
    const beltUp = newBelt > save.belt;
    save.belt = newBelt;

    // Creature rewards
    let newCreature = null;
    if (stars >= 2 && score >= 7) {
      const worldIdx = WORLDS.findIndex(w => w.topics.some(t => t.id === currentTopic.id));
      const creaturePool = CREATURES.filter(c => !save.collection.includes(c.id));
      if (creaturePool.length > 0) {
        newCreature = creaturePool[rnd(0, Math.min(2, creaturePool.length - 1))];
        save.collection.push(newCreature.id);
      }
    }

    // Check achievements
    checkAchievements();
    saveGame();

    // Show results
    document.getElementById('results-title').textContent = stars >= 1 ? 'VICTORY!' : 'TRY AGAIN!';
    const starsHtml = `<div class="stars-earned" style="font-size:32px;margin:8px 0">${
      Array.from({length:3}, (_,i) => `<span class="star">${i < stars ? '\u2B50' : '\u2606'}</span>`).join('')
    }</div>`;
    document.getElementById('results-stats').innerHTML = `
      Score: ${score}/${total} (${pct}%)<br>
      ${starsHtml}
      Max Combo: ${battleState.maxCombo}x<br>
      Time: ${timeTaken}s<br>
      XP Earned: +${xpEarned}
    `;

    const rewards = document.getElementById('rewards-area');
    rewards.innerHTML = '';
    if (newCreature) {
      rewards.innerHTML += `<div class="reward-item"><div class="reward-icon">${newCreature.emoji}</div><div class="reward-text">Caught ${newCreature.name}!</div></div>`;
    }
    if (leveled) {
      rewards.innerHTML += `<div class="reward-item"><div class="reward-icon">&#11088;</div><div class="reward-text">Level ${save.level}!</div></div>`;
    }
    if (beltUp) {
      rewards.innerHTML += `<div class="reward-item"><div class="reward-icon">&#129399;</div><div class="reward-text">${BELTS[save.belt].name}!</div></div>`;
    }

    showScreen('results-screen');

    // Victory confetti
    if (stars >= 1) {
      setTimeout(() => {
        spawnConfetti(window.innerWidth / 2, window.innerHeight / 3);
        setTimeout(() => spawnConfetti(window.innerWidth * 0.3, window.innerHeight / 4), 200);
        setTimeout(() => spawnConfetti(window.innerWidth * 0.7, window.innerHeight / 4), 400);
      }, 300);
    }

    if (leveled) {
      setTimeout(() => {
        sfxLevelUp();
        const overlay = document.getElementById('level-up-overlay');
        const box = document.getElementById('level-up-box');
        box.innerHTML = `
          <h2>LEVEL UP!</h2>
          <div style="font-size:48px;margin:12px 0">&#11088;</div>
          <p style="font-size:18px">Henry reached Level ${save.level}!</p>
          ${beltUp ? `<p style="color:${BELTS[save.belt].color};font-size:16px;margin-top:8px">${BELTS[save.belt].name} unlocked!</p>` : ''}
          ${newCreature ? `<p style="margin-top:8px">${newCreature.emoji} ${newCreature.name} joined your team!</p>` : ''}
          <button class="btn btn-gold" onclick="document.getElementById('level-up-overlay').classList.remove('active')" style="margin-top:16px">Awesome!</button>
        `;
        overlay.classList.add('active');
      }, 500);
    }
  }

  function replayBattle() {
    if (currentTopic) startBattle(currentTopic);
  }

  // ---- ACHIEVEMENTS ----
  const ACHIEVEMENTS = [
    {id:'first_battle',name:'First Steps',desc:'Complete your first battle',icon:'&#128095;',check:()=>save.totalBattles>=1},
    {id:'streak_3',name:'On Fire',desc:'3 day streak',icon:'&#128293;',check:()=>save.bestStreak>=3},
    {id:'streak_7',name:'Unstoppable',desc:'7 day streak',icon:'&#128293;',check:()=>save.bestStreak>=7},
    {id:'combo_5',name:'Combo Master',desc:'5x combo in battle',icon:'&#9889;',check:()=>save.totalCorrect>=50},
    {id:'collect_5',name:'Creature Collector',desc:'Catch 5 creatures',icon:'&#128050;',check:()=>save.collection.length>=5},
    {id:'collect_all',name:'Gotta Catch Em All',desc:'Catch all creatures',icon:'&#127942;',check:()=>save.collection.length>=CREATURES.length},
    {id:'lv5',name:'Rising Ninja',desc:'Reach level 5',icon:'&#129399;',check:()=>save.level>=5},
    {id:'lv10',name:'Math Warrior',desc:'Reach level 10',icon:'&#128170;',check:()=>save.level>=10},
    {id:'lv20',name:'Math Legend',desc:'Reach level 20',icon:'&#128081;',check:()=>save.level>=20},
    {id:'100correct',name:'Century',desc:'100 correct answers',icon:'&#128175;',check:()=>save.totalCorrect>=100},
    {id:'500correct',name:'Math Machine',desc:'500 correct answers',icon:'&#129302;',check:()=>save.totalCorrect>=500},
    {id:'allnumber',name:'Number Master',desc:'Complete all Number topics',icon:'&#128290;',check:()=>WORLDS[0].topics.every(t=>save.topicProgress[t.id]?.completed)},
    {id:'allworlds',name:'Curriculum Champion',desc:'Complete all worlds',icon:'&#127942;',check:()=>WORLDS.every(w=>w.topics.every(t=>save.topicProgress[t.id]?.completed))},
  ];

  function checkAchievements() {
    ACHIEVEMENTS.forEach(a => {
      if (!save.achievements.includes(a.id) && a.check()) {
        save.achievements.push(a.id);
        showToast(`Achievement: ${a.icon} ${a.name}!`);
      }
    });
  }

  // ---- STATS SCREEN ----
  function renderStats() {
    const c = document.getElementById('stats-content');
    const accuracy = save.totalAnswered > 0 ? Math.round(save.totalCorrect / save.totalAnswered * 100) : 0;
    c.innerHTML = `
      <h2 style="font-family:'Press Start 2P',monospace;color:var(--mc-gold);text-align:center;margin-bottom:20px;font-size:clamp(12px,3vw,20px)">
        Henry's Profile
      </h2>
      <div class="stats-section">
        <h3>&#129399; Ninja Stats</h3>
        <p>Level: ${save.level} | Belt: ${BELTS[save.belt].name}</p>
        <p>Total XP: ${save.totalXp} | Streak: ${save.streak} days (Best: ${save.bestStreak})</p>
        <p>Battles: ${save.totalBattles} | Accuracy: ${accuracy}%</p>
        <p>Correct: ${save.totalCorrect} / ${save.totalAnswered}</p>
      </div>
      <div class="stats-section">
        <h3>&#128050; Creature Collection (${save.collection.length}/${CREATURES.length})</h3>
        <div class="collection-grid">
          ${CREATURES.map(c => `
            <div class="collection-item ${save.collection.includes(c.id) ? '' : 'locked'}" title="${c.name}: ${c.desc}">
              ${c.emoji}
            </div>
          `).join('')}
        </div>
      </div>
      <div class="stats-section">
        <h3>&#127942; Achievements (${save.achievements.length}/${ACHIEVEMENTS.length})</h3>
        ${ACHIEVEMENTS.map(a => `
          <div class="achievement-row ${save.achievements.includes(a.id) ? 'earned' : ''}">
            <span>${a.icon}</span>
            <span style="flex:1"><strong>${a.name}</strong><br><small style="opacity:0.7">${a.desc}</small></span>
            <span>${save.achievements.includes(a.id) ? '&#10003;' : '&#128274;'}</span>
          </div>
        `).join('')}
      </div>
      <div style="text-align:center;margin-top:16px">
        <button class="btn btn-primary" onclick="if(confirm('Reset all progress?')){localStorage.removeItem('${SAVE_KEY}');location.reload()}" style="font-size:12px;padding:8px 16px">Reset Progress</button>
      </div>
    `;
  }

  // ---- TOAST NOTIFICATIONS ----
  function showToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerHTML = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
  }

  // ---- STREAK CHECK ----
  function checkStreak() {
    const today = new Date().toDateString();
    if (save.lastPlayDate === today && save.streak > 0) {
      const banner = document.getElementById('streak-banner');
      banner.innerHTML = `&#128293; ${save.streak} day streak! Keep it up Henry!`;
      banner.style.display = 'block';
      setTimeout(() => banner.style.display = 'none', 4000);
    }
  }

  // ---- START ----
  function startGame() {
    showScreen('map-screen');
    checkStreak();
  }

  // ---- FULLSCREEN ----
  document.addEventListener('keydown', e => {
    if (e.key === 'f' && !e.ctrlKey && !e.metaKey && document.activeElement?.tagName !== 'INPUT') {
      if (document.fullscreenElement) document.exitFullscreen();
      else document.documentElement.requestFullscreen().catch(() => {});
    }
    if (e.key === 'Enter' && document.activeElement?.id === 'number-input') {
      submitTypedAnswer();
    }
  });

  // ---- PARTICLE SYSTEM ----
  const particleCanvas = document.getElementById('particle-canvas');
  const pCtx = particleCanvas.getContext('2d');
  let particles = [];
  function resizeParticleCanvas() {
    particleCanvas.width = window.innerWidth;
    particleCanvas.height = window.innerHeight;
  }
  resizeParticleCanvas();
  window.addEventListener('resize', resizeParticleCanvas);

  class Particle {
    constructor(x, y, color, size, vx, vy, life) {
      this.x = x; this.y = y; this.color = color;
      this.size = size; this.vx = vx; this.vy = vy;
      this.life = life; this.maxLife = life; this.alpha = 1;
    }
    update() {
      this.x += this.vx; this.y += this.vy;
      this.vy += 0.05;
      this.life--;
      this.alpha = Math.max(0, this.life / this.maxLife);
    }
    draw(ctx) {
      ctx.save();
      ctx.globalAlpha = this.alpha;
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
      ctx.restore();
    }
  }

  function spawnParticles(x, y, color, count=15) {
    for (let i = 0; i < count; i++) {
      const angle = Math.random() * Math.PI * 2;
      const speed = 1 + Math.random() * 4;
      particles.push(new Particle(
        x, y, color,
        2 + Math.random() * 4,
        Math.cos(angle) * speed,
        Math.sin(angle) * speed - 2,
        30 + Math.random() * 30
      ));
    }
  }

  function spawnConfetti(x, y) {
    const colors = ['#FFD700','#FF4444','#44DD44','#4488FF','#FF44FF','#44FFFF'];
    for (let i = 0; i < 40; i++) {
      const angle = Math.random() * Math.PI * 2;
      const speed = 2 + Math.random() * 6;
      particles.push(new Particle(
        x, y, colors[Math.floor(Math.random()*colors.length)],
        3 + Math.random() * 5,
        Math.cos(angle) * speed,
        Math.sin(angle) * speed - 4,
        60 + Math.random() * 40
      ));
    }
  }

  // Ambient floating particles
  let ambientTimer = 0;
  function updateParticles() {
    pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

    // Spawn ambient particles
    ambientTimer++;
    if (ambientTimer % 8 === 0) {
      const activeScreen = document.querySelector('.screen.active')?.id;
      let color = 'rgba(255,215,0,0.3)';
      if (activeScreen === 'battle-screen') color = 'rgba(255,68,68,0.25)';
      else if (activeScreen === 'map-screen') color = 'rgba(135,206,235,0.2)';
      particles.push(new Particle(
        Math.random() * particleCanvas.width,
        particleCanvas.height + 5,
        color, 2 + Math.random() * 3,
        (Math.random() - 0.5) * 0.5,
        -0.5 - Math.random() * 1,
        100 + Math.random() * 100
      ));
    }

    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => { p.update(); p.draw(pCtx); });
    requestAnimationFrame(updateParticles);
  }
  updateParticles();

  // ---- INIT ----
  loadGame();

  // ---- render_game_to_text ----
  window.render_game_to_text = () => JSON.stringify({
    screen: document.querySelector('.screen.active')?.id || 'none',
    level: save.level, xp: save.xp, belt: BELTS[save.belt].name,
    streak: save.streak, collection: save.collection.length,
    achievements: save.achievements.length,
    totalCorrect: save.totalCorrect, totalAnswered: save.totalAnswered,
    battle: battleState ? {
      topic: currentTopic?.name, question: battleState.currentQ,
      score: battleState.score, combo: battleState.combo,
      enemyHp: battleState.enemyHp,
    } : null,
  });

  window.advanceTime = (ms) => {};

  return { showScreen, startGame, submitTypedAnswer, replayBattle, checkAnswer };
})();
</script>
</body>
</html>
